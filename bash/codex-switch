#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LOCAL_BIN="$REPO_ROOT/codex-mp"
VERSION_FILE="$REPO_ROOT/VERSION"
GO_MAIN="$REPO_ROOT/go/cmd/codex-mp/main.go"

expected_version=""
if [[ -f "$VERSION_FILE" ]]; then
  expected_version="$(tr -d '[:space:]' < "$VERSION_FILE")"
fi

have_fresh_local_bin() {
  [[ -x "$LOCAL_BIN" ]] || return 1
  [[ -n "$expected_version" ]] || return 0

  local current_version
  current_version="$("$LOCAL_BIN" version 2>/dev/null || true)"
  [[ "$current_version" == "$expected_version" ]]
}

build_local_bin() {
  command -v go >/dev/null 2>&1 || return 1
  [[ -f "$GO_MAIN" ]] || return 1

  local ldflags
  if [[ -n "$expected_version" ]]; then
    ldflags="-X github.com/BigCactusLabs/codex-multipass/internal/app.Version=$expected_version"
  else
    ldflags="-X github.com/BigCactusLabs/codex-multipass/internal/app.Version=dev"
  fi

  (
    cd "$REPO_ROOT/go"
    go build -ldflags "$ldflags" -o "$LOCAL_BIN" cmd/codex-mp/main.go
  )
}

if have_fresh_local_bin; then
  exec "$LOCAL_BIN" "$@"
fi

if build_local_bin && have_fresh_local_bin; then
  exec "$LOCAL_BIN" "$@"
fi

if command -v codex-mp >/dev/null 2>&1; then
  exec codex-mp "$@"
fi

echo "Error: codex-mp binary not found. Build with 'make build' or install codex-mp." >&2
exit 1
